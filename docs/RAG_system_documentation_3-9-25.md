# Milea Estate Vineyard RAG System Architecture

## Overview

The Milea Estate Vineyard chatbot uses a Retrieval-Augmented Generation (RAG) architecture to provide accurate, context-aware responses about the vineyard's wines, visiting information, wine club, and other offerings. The system follows a modular design with clear separation of concerns, enabling specialized handling for different types of queries.

## Core Components

The RAG system consists of these main components:

1. **RAG Service (`ragService.js`)**: Main entry point that coordinates the entire RAG pipeline
2. **Query Classification (`queryClassifier.js`)**: Analyzes user queries to determine intent and domain
3. **Context Assembly (`context/index.js`)**: Retrieves and processes relevant documents
4. **Domain Handlers (`domains/`)**: Domain-specific processing for different query types
5. **Response Generation (`responseGenerator.js`)**: Uses OpenAI models to generate final responses
6. **Conversation Tracking (`conversationTracking.js`)**: Maintains state for multi-turn conversations
7. **Cache Management (`cacheManager.js`)**: Efficiently caches responses for similar queries

## Query Flow

The RAG pipeline follows this sequential flow:

![RAG Pipeline Flow](https://i.imgur.com/XYZ123.png)

1. **Entry Point**: User query enters through `generateRAGResponse()` in `ragService.js`
2. **Pipeline Processing**: Query is processed by `processRagPipeline()` in `core.js`
3. **Query Classification**: Query is classified by `classifyQuery()` in `queryClassifier.js`
4. **Context Assembly**: Relevant documents are retrieved and processed by `assembleContext()` in `context/index.js`
5. **Domain Handling**: The appropriate domain handler processes the query based on its classification
6. **Response Generation**: A final response is generated by `generateResponse()` in `responseGenerator.js`
7. **Response Delivery**: The response is returned to the user, with sources of information

## Detailed Component Descriptions

### 1. RAG Service (`ragService.js`)

The RAG Service functions as the entry point and coordinator for the entire RAG system:

```javascript
async function generateRAGResponse(query, previousMessages = []) {
  const requestId = `req-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
  
  logger.info(`ðŸš€ [${requestId}] Starting RAG processing for query: "${query}"`);
  logger.info(`ðŸ“œ [${requestId}] Previous messages count: ${previousMessages.length}`);
  conversationTracker.logStats();
  
  try {
    return await processRagPipeline(query, previousMessages, requestId);
  } catch (error) {
    logger.error(`âŒ [${requestId}] RAG Response Generation Error: ${error.message}`);
    logger.error(`ðŸ” [${requestId}] Error stack: ${error.stack}`);
    
    return { 
      response: "I apologize, but I'm having trouble generating a response right now. Please try rephrasing your question.",
      sources: []
    };
  }
}
```

Key responsibilities:
- Initiates the processing pipeline
- Handles error cases gracefully
- Provides cache management functionality
- Tracks conversation state

### 2. Core Processing (`core.js`)

The Core module handles the main processing flow of the RAG pipeline:

```javascript
async function processRagPipeline(query, previousMessages, requestId) {
  // Conversation context handling
  // Cache checking
  // Query classification
  // Context assembly
  // Domain-specific processing
  // Response generation
  // Cache updating
}
```

Key features:
- Handles multi-turn conversations
- Implements context-aware caching
- Coordinates all components of the pipeline
- Special handling for wine follow-up queries
- Domain-specific request routing

### 3. Query Classification (`queryClassifier.js`)

The Query Classifier determines the type and intent of user queries:

```javascript
function classifyQuery(query) {
  const queryLower = query.toLowerCase();
  
  // Direct matching for wine patterns
  const specificWine = identifySpecificWinePattern(query);
  if (specificWine) {
    return {
      type: 'wine',
      subtype: 'specific',
      isSpecificWine: true,
      specificWine: specificWine.name,
      winePattern: specificWine.pattern,
      wineTerms: specificWine.name.split(' '),
      isConfirmedWine: true,
      isGenericProceedo: specificWine.isGeneric || false
    };
  }
  
  // Domain-specific classification methods
  // Business hours, wine club, loyalty program, etc.
}
```

Classification hierarchy (in order of precedence):
1. Specific wine patterns
2. Business hours queries
3. Wine club queries
4. Loyalty program queries
5. Wine production queries
6. Sustainability queries
7. Visiting-related queries
8. Generic wine queries
9. Merchandise queries
10. General queries (fallback)

### 4. Context Assembly (`context/index.js`)

The Context Assembly system retrieves and processes relevant documents:

```javascript
async function assembleContext(query, queryInfo) {
  // Determine number of documents to retrieve
  // Retrieve documents from vector store
  // Validate document relevance
  // Score and filter documents
  // Group documents by type
  // Select final documents for context
}
```

This module consists of several interrelated components:
- **Validator (`validator.js`)**: Ensures retrieved documents are relevant and valid
- **Scorer (`scorer.js`)**: Ranks documents by relevance to the query
- **Grouper (`grouper.js`)**: Groups related documents (e.g., wine vintages)
- **Selector (`selector.js`)**: Selects the final set of documents to use
- **HTML Cleaner (`utils/htmlCleaner.js`)**: Processes HTML content in documents

### 5. Domain Handlers (`domains/`)

Domain handlers provide specialized processing for different query types:

| Handler | Purpose |
|---------|---------|
| `wineHandler.js` | Handles wine product queries |
| `visitingHandler.js` | Handles visiting-related queries |
| `clubHandler.js` | Handles wine club queries |
| `loyaltyHandler.js` | Handles Milea Miles loyalty program queries |
| `businessHoursHandler.js` | Handles business hours queries |
| `merchandiseHandler.js` | Handles merchandise queries |
| `wine_productionHandler.js` | Handles wine production queries |
| `sustainabilityHandler.js` | Handles sustainability queries |
| `generalHandler.js` | Fallback for general queries |

Example of domain-specific processing in `wineHandler.js`:

```javascript
async function handleQuery(query, queryInfo, context) {
  // Special handling for wine queries
  // Proceedo wine handling
  // Reserve Cabernet Franc handling
  // RosÃ© wine handling
  // Generic wine type queries
}
```

### 6. Response Generation (`responseGenerator.js`)

The Response Generator creates the final response using the LLM:

```javascript
async function generateResponse(query, queryInfo, context, additionalData = {}) {
  // Build context from relevant documents
  // Construct prompt based on query type
  // Generate response using OpenAI
  // Format and return response
}
```

Key features:
- Dynamic prompt construction based on query type
- Wine-specific instructions for accurate responses
- Verified wine list enforcement
- Domain-specific formatting guidance
- Custom handling for multiple wine scenarios

### 7. Conversation Tracking (`conversationTracking.js`)

The Conversation Tracker maintains state for multi-turn dialogues:

```javascript
class ConversationTracker {
  constructor() {
    this.pendingClarification = new Map();
    this.clarificationResponded = new Map();
    this.conversationContext = new Map();
    this.WINE_NAME_MAPPINGS = {
      // Wine mappings for follow-up clarification
    };
  }
  
  // Functions for tracking and processing conversation state
}
```

Key capabilities:
- Tracks queries needing clarification
- Monitors clarification responses
- Stores conversation context
- Maps wine names for follow-up queries
- Clears conversation state as needed

### 8. Cache Management (`cacheManager.js`)

The Cache Manager provides efficient response caching:

```javascript
class CacheManager {
  constructor(maxSize = 100, ttl = 1000 * 60 * 15) {
    this.cache = {};
    this.maxSize = maxSize;
    this.ttl = ttl; // 15 minutes in milliseconds by default
  }
  
  // Cache management functions
}
```

Features:
- In-memory cache with configurable size and TTL
- Context-aware caching for multi-turn conversations
- LRU (Least Recently Used) eviction strategy

## Domain Handler Integration

Domain handlers integrate with the main RAG pipeline as follows:

1. The query is classified by `queryClassifier.js`
2. Based on the classification, the appropriate domain handler is selected in `core.js`:
   ```javascript
   const handler = DOMAIN_HANDLERS[queryInfo.type] || generalHandler;
   let responseData = await handler.handleQuery(query, queryInfo, context);
   ```
3. The domain handler processes the query using domain-specific logic
4. If the handler doesn't return a complete response, the response generator is used:
   ```javascript
   if (!responseData.response) {
     const finalResponse = await generateResponse(query, queryInfo, context, responseData);
   }
   ```

## Special Handling for Wine Queries

Wine queries receive specialized handling due to their importance:

1. **Wine Classification**: Wine queries are classified into specific categories
   - Specific wine queries (e.g., "Reserve Cabernet Franc")
   - Generic wine type queries (e.g., "Cabernet Franc wines")
   - Wine price queries

2. **Wine Pattern Detection**: The system uses sophisticated pattern detection
   ```javascript
   function identifySpecificWinePattern(query) {
     // Wine-specific pattern matching with proximity checking
   }
   ```

3. **Wine Document Validation**: Wine documents undergo strict validation
   ```javascript
   function validateResults(results, queryInfo, query) {
     // Wine-specific document validation
   }
   ```

4. **Wine Domain Handler**: Special processing in `wineHandler.js`
   - Proceedo wine variants (white/rosÃ©)
   - Reserve Cabernet Franc
   - RosÃ© wines
   - Multiple wine clarification

5. **Wine-specific Response Generation**: Specialized response formatting
   ```javascript
   function getEnhancedWineInstructions() {
     // Enhanced wine detail extraction instructions
   }
   ```

## Multi-turn Conversation Handling

The system supports multi-turn conversations:

1. **Previous Message Context**: Considers previous messages in conversations
   ```javascript
   if (previousMessages.length > 0) {
     const previousResponse = previousMessages[previousMessages.length - 1];
     // Check for wine clarification requests
     // Store conversation context
   }
   ```

2. **Wine Clarification**: Detects wine clarification requests
   ```javascript
   function isWineClarificationRequest(response) {
     // Detect patterns indicating clarification needs
   }
   ```

3. **Follow-up Processing**: Special handling for follow-up queries
   ```javascript
   async function processWineFollowUp(query, wineInfo, requestId) {
     // Special processing for wine follow-up queries
   }
   ```

## Integration with External Services

The RAG system integrates with several external services:

1. **Vector Store**: Retrieves documents from ChromaDB
   ```javascript
   const semanticResults = await searchSimilarDocuments(query, k);
   ```

2. **OpenAI**: Generates responses using GPT models
   ```javascript
   const response = await openai.chat.completions.create({
     model: model,
     messages: [{ role: "user", content: promptTemplate }],
     temperature: 0.2
   });
   ```

3. **Business Hours API**: Retrieves up-to-date business hours
   ```javascript
   const response = await axios.get('http://localhost:8080/api/business/hours');
   ```

## Performance Optimization

The system implements several performance optimizations:

1. **Caching**: Efficient response caching with TTL
2. **Request ID Tracking**: Unique IDs for tracking request processing
3. **Document Filtering**: Early filtering of irrelevant documents
4. **Selective Model Usage**: Uses different models based on query complexity:
   ```javascript
   function determineModel(queryInfo) {
     // Simple query types can use a faster model
     const simpleQueryTypes = ['business-hours', 'visiting-hours', 'visiting-directions'];
     const useSimpleModel = simpleQueryTypes.includes(queryInfo.type) || 
                             (queryInfo.type === 'visiting' && simpleQueryTypes.includes(queryInfo.subtype));
     
     return useSimpleModel ? "gpt-3.5-turbo" : "gpt-4";
   }
   ```

## Debugging and Monitoring

The system includes comprehensive logging for debugging and monitoring:

```javascript
logger.info(`ðŸš€ [${requestId}] Starting RAG processing for query: "${query}"`);
logger.wine(`Document ${index+1}: Source=${doc.metadata.source}`);
logger.error('Error in wine handler:', error);
```

Key logging areas:
- Query processing steps
- Document retrieval and validation
- Classification decisions
- Caching operations
- Error cases
- Performance timing

## Known Wine Database

The system maintains a hardcoded list of known wines for validation:

```javascript
async function extractWinesFromKnowledgeBase() {
  try {
    // Return hardcoded list of confirmed wines
    // This avoids filesystem issues during initial setup
    return [
      {
        name: "Reserve Cabernet Franc",
        vintage: "2022",
        price: "36.00",
        isAvailable: true
      },
      // Other wines...
    ];
  } catch (error) {
    console.error('Error extracting wines from knowledge base:', error);
    return [];
  }
}
```

## Conclusion

The Milea Estate Vineyard RAG system follows a comprehensive, modular architecture that enables accurate, context-aware responses. The system's specialized handling for wine queries ensures high-quality information about the vineyard's primary product, while also supporting various other query domains. The conversation tracking and caching mechanisms enhance the user experience with efficient, contextually appropriate responses.